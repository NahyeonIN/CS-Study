<h1> Normalization (정규화) </h1>

데이터베이스를 잘못 설계하면 불필요한 데이터 중복이 발생하게 되고
릴레이션에 대한 데이터의 삽입/수정/삭제 연산을 수행할 때 부작용이 발생하게 된다.
이러한 부작용을 이상현상 (anomaly)이라고 한다.
이상현상을 제거하면서 데이터의 일관성과, 유연성, 무결성 확보를 위해 데이터를 분해 하는 과정을 <b>정규화</b> 라고 한다.

<h3> 이상현상의 종류 </h3>
1. 삽입이상 (insertion anomaly)<br>
새 데이터를 삽입 하기 위해 불필요한 데이터도 함께 삽입을 해야 하는 이슈<br>
2. 갱신이상 (update anomaly)<br>
데이터 수정 시 일부만 수정하여 데이터 불일치가 일어나는 이슈<br>
3. 삭제이상 (deletion anomaly)<br>
데이터 삭제 시 의도와 상관없이 다른 정보까지 삭제하여 데이터가 손실되는 연쇄 삭제 이슈<br>

<h3> 정규화 과정 </h3>

<h4> 제 1 정규형 1NF (First Normal Form) </h4>
테이블의 컬럼이 원자값(Atomic Value, 하나의 값)을 갖도록 테이블을 분해하는 것<br><br>

| 고객아이디(pk) | 이벤트아이디(pk) | 당첨여부 | 둥급 | 할인율 |
|---|---|---|---|---|
| apple | E001, E005, E010  | Y,N,Y | gold | 10% |
| banana | E002, E005  | N,Y | vip | 20% |
| carrot | E003, E007  | Y,Y | gold | 10% |
| peach  | E004  | N  | sliver  | 5%  |

| 고객아이디(pk) | 이벤트아이디(pk) | 당첨여부 | 둥급 | 할인율 |
|---|---|---|---|---|
| apple | E001 | Y | gold | 10% |
| apple | E005  | N | gold | 10% |
| apple | E010 | Y | gold | 10% |
| banana | E002 | N | vip | 20% |
| banana | E005  | Y | vip | 20% |
| carrot | E003  | Y | gold | 10% |
| carrot | E007  | Y | gold | 10% |
| peach  | E004  | N  | sliver  | 5%  |

이러한 제 1 정규화 이후에도 삽입, 갱신, 삭제 이상이 발생한다.

- 삽입이상<br>
새 고객에 대한 데이터를 삽입하려면 해당 고객은 이벤트에 무조건 참여해야 한다. 이벤트에 참여하지 않을 경우 기본키를 구성하는 이벤트번호 속성이 NULL 으로 개체 무결성(Entity integrity) 제약조건을 위반하게 된다.
- 갱신 이상<br>
위의 테이블에서 고객의 등급과 할인율 속성 값이 중복되어 있다. 만약 한 고객에 대한 등급을 변경하면 해당 고객아이디에 해당하는 모든 데이터들의 등급속성을 변경해야 한다.<br>
만약 일부 컬럼만 변경하게 되면 동일한 고객이 2개의 등급 값을 가져 데이터 일관성에 어긋난다.
- 삭제 이상<br>
고객 아이디가 peach인 고객에 대한 컬럼은 하나이다. 해당 고객이 E004 이벤트에 참여한 기록을 삭제해달라는 요구가 있어 이행할 경우, <br>
peach 고객의 등급과 할인율 같은 고객정보도 함께 삭제가 된다.<br>

<h5> 이상 현상이 발생하는 이유</h5>
위의 테이블이 부분 함수 종속을 포함하고 있다 <br>
:point_right: 기본키인 {고객아이디, 이벤트번호}에 완전 함수 종속 되지 못하고, 고객아이디에 종속 되는 등급과 할인율 속성 때문.

<h4> 제 2 정규형 2NF (Second Normal Form) </h4>
부분 함수 종속을 제거하고 모든 속성이 기본키에 완전 종속 되도록 테이블을 분해 하는 과정.<br>
즉 위처럼 기본키의 부분집합이 (고객아이디) 결정자가 되지 않도록 분해한다.<br>

<br> <고객 테이블> <br>
| 고객아이디(pk) | 둥급 | 할인율 |
|---|---|---|
| apple | gold | 10% |
| banana | vip | 20% |
| carrot | gold | 10% |
| peach  | sliver  | 5% |


<br> <이벤트참여 테이블> <br>
| 고객아이디(pk) | 이벤트아이디(pk) | 당첨여부 |
|---|---|---|
| apple | E001 | Y |
| apple | E005 | N |
| apple | E010 | Y |
| banana | E002 | N |
| banana | E005 | Y |
| carrot | E003 | Y |
| carrot | E007 | Y |
| peach  | E004  | N |

:warning: 테이블 분해 시 주의점 <br>
분해된 테이블들을 자연 조인하여 분해 전의 테이블로 다시 복원할 수 있어야 함.<br>
정보의 손실 없이 테이블을 분해하는 무손실 분해 (nonloss decomposition). <br>

이러한 제 2 정규화 이후에도 삽입, 갱신, 삭제 이상이 발생한다.

- 삽입 이상 <br>
새로운 등급과 할인율을 삽입 하기 위해선 해당 등급에 속하는 고객이 있어야 고객테이블에 삽입이 가능하다.<br>
고객테이블의 pk에 해당하는 고객아이디가 NULL이면 삽입이 불가능하기 때문.
- 갱신 이상 <br>
등급에 대한 할인율을 변경할 시에 해당 등급에 관련된 모든 tuple 에서 할인율 속성 값을 똑같이 변경해야 함. <br>
gold의 할인률을 10%에서 -> 15%으로 변경하기 위해선 apple, carrot 두개의 tuple을 모두 변경해야 한다. <br>
- 삭제 이상 <br>
고객 탈퇴로 고객테이블에서 해당 고객에 대한 tuple 삭제가 발생하면 등급과 할인율에 대한 정보까지 삭제된다. <br>
banana 고객이 탈퇴할 때, 고객테이블에서 해당 고객에 대한 tuple을 삭제하면 VIP 등급의 할인율이 20%라는 정보도 함께 삭제가 된다.<br>

<h5> 이상 현상이 발생하는 이유</h5>
함수적 종속 관계를 여러개 포함 하고 있어, 결과적으로 이해적 함수 종속이 생겨 발생한 이슈.<br>
<img src="https://github.com/NahyeonIN/CS-Study/assets/139699053/0d881c7b-8346-4040-8fd4-699f706feaee"  width="500" height="300"><br>
이러한 이행적 함수 종속이 나타나는 이유는 함수 종속 관계가 하나의 테이블에 여러개 존재하기 때문.

<h4> 제 3 정규형 3NF (Third Normal Form) </h4>

제 2 정규형을 만족하면서, 기본키가 아닌 모든 속성이 기본키에 이행적 함수 종속이 되지 않으면 제 3 정규형에 속함. <br>
할인율은 등급에 따라 달라지는 것으로, 고객아이디에 따라 할인율이 달라지는 것이 아님. <br>
그러나 고객아이디, 등급, 할인율 속성을 모두 하나의 테이블에 넣어, 고객아이디가 할인율을 결정하게 되면서 이상 현상이 나타남.<br>
즉 이행적 함수 종속성으로 인해 이상 현상 발생.<br><br>
고객아이디 - - - > 등급 - - -> 할인율 <br>

<br> <고객 테이블> <br>
| 고객아이디(pk) | 둥급 |
|---|---|
| apple | gold | 
| banana | vip |
| carrot | gold |
| peach  | sliver  |

<br> <고객등급 테이블> <br>
| 둥급 | 할인율 |
|---|---|
| gold | 10% |
| vip | 20% |
| sliver  | 5% |



